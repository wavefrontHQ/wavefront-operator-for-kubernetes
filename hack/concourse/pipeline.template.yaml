resources:
- name: 9am
  type: time
  source:
    start: 9:00 AM
    stop: 10:00 AM
    location: America/Denver
# TODO probably overkill; start with simple bash-ing
#- name: ytt
#  type: registry-image
#  source:
#    repository: taylorsilva/carvel-ytt
#    tag: 0.36
- name: wavefront-operator-ci
  type: git
  source:
    uri: git@github.com:wavefrontHQ/wavefront-operator-for-kubernetes.git
    branch: main
    private_key: ((osspi.jcornish-github-private-key)) # TODO use a deploy key

- name: wavefront-operator-<feature JIRA>
  type: git
  source:
    uri: git@github.com:wavefrontHQ/wavefront-operator-for-kubernetes.git
    branch: <feature JIRA>-whatever
    private_key: ((osspi.jcornish-github-private-key)) # TODO use a deploy key
#+ {{ feature_branch_resources }}
jobs:
  - name: update-self
    plan:
    - get: 9am
      trigger: true
    - get: wavefront-operator-ci
    - task: generate-pipeline
      file: wavefront-operator/hack/concourse/tasks/generate-pipeline.yaml

    # generate pipeline based on active branches
    # trigger 9am or manually
    - set_pipeline: operator-gitops
      file: wavefront-operator/hack/concourse/pipeline.yaml

  - name: setup-<feature JIRA>-cluster
    # trigger 9am
    # trigger on push to branch
    # for each branch with push today, create dev cluster
    # I think only trigger on push, but could also be daily
  - name: teardown-all-feature-clusters
    # trigger 5pm
    # ideal: gcloud search by pattern 'k8po-operator-gitops-<feature JIRA>'
    # but that's maybe not safe so instead
  - name: teardown-<feature JIRA>-cluster

  - name: submit-<feature JIRA>-for-acceptance
    plan:
    - get: wavefront-operator
      branch: <feature JIRA>
    # create acceptance GKE cluster
    # teardown-<feature JIRA>-cluster
  - name: accept-<feature JIRA>
    # create PR from feature JIRA into release-elect and try to automatically merge
    # promote release-elect to release
  - name: reject-<feature JIRA>
    # stretch goal: send slack notification or something
